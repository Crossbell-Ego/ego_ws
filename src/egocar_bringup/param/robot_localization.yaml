# 這是修正後的 robot_localization.yaml 設定檔
#
# 主要修正：
# 1. odom0 (輪式里程計): 只提供 vx 和 vy (X, Y軸線速度)，不再提供角速度。
# 2. imu0 (IMU): 提供 roll/pitch 角度和所有軸的角速度，但不再提供絕對的 yaw 角度。
# 3. 這樣的配置可以避免輪子打滑估算的角速度和IMU漂移的角速度/角度產生衝突。
# 4. 將 differential 模式設為 false，因為我們直接使用感測器提供的速度值。

ekf_localization:
  ros__parameters:
    # 頻率 (Hz)，濾波器將以此頻率輸出位置估計。
    frequency: 20.0

    # 感測器超時時間 (秒)。
    sensor_timeout: 0.1

    # 是否啟用二維模式。在平面環境中設為 true。
    two_d_mode: true

    # 轉換時間戳偏移。
    transform_time_offset: 0.0
    transform_timeout: 0.0

    # 是否列印診斷訊息。
    print_diagnostics: true

    # --- Debug 設定 ---
    debug: false
    debug_out_file: /path/to/debug/file.txt

    # 是否發布加速度狀態。
    publish_acceleration: false

    # --- Frame設定 (座標系名稱) ---
    map_frame: map
    odom_frame: odom
    base_link_frame: base_footprint
    world_frame: odom

    # --- 感測器輸入設定 (這是關鍵修改區域) ---

    # 輪式里程計
    odom0: /odom_raw
    odom0_config: [false, false, false,  # X, Y, Z (位置)
                   false, false, false,  # Roll, Pitch, Yaw (角度)
                   true,  true,  false,  # 使用 vx, vy (線速度)，不使用 vz
                   false, false, false,  # 不再使用輪式里程計的角速度
                   false, false, false]  # ax, ay, az (加速度)
    odom0_queue_size: 2
    odom0_nodelay: false
    odom0_differential: false # 因為直接使用速度，而非位置變化量，所以設為 false
    odom0_relative: false

    # IMU 感測器
    imu0: /imu/imu_data
    imu0_config: [false, false, false,  # X, Y, Z (位置)
                  true,  true,  false,  # 使用 Roll, Pitch 修正姿態，不使用絕對 Yaw
                  false, false, false,  # vx, vy, vz (線速度)
                  true,  true,  true,   # 使用 IMU 提供的所有角速度
                  false, false, false]  # ax, ay, az (加速度)
    imu0_differential: false # 因為直接使用 IMU 提供的角速度，所以設為 false
    imu0_relative: false
    imu0_queue_size: 5
    imu0_remove_gravitational_acceleration: true

    # --- 運動模型參數 (過程雜訊協方差矩陣，保持不變) ---
    process_noise_covariance: [0.05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                               0.0, 0.05, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                               0.0, 0.0, 0.06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                               0.0, 0.0, 0.0, 0.03, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                               0.0, 0.0, 0.0, 0.0, 0.03, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                               0.0, 0.0, 0.0, 0.0, 0.0, 0.06, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                               0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.025, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                               0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.025, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                               0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.04, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                               0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0, 0.0,
                               0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0, 0.0, 0.0,
                               0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.02, 0.0, 0.0, 0.0,
                               0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0, 0.0,
                               0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.01, 0.0,
                               0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.015]

    # --- 初始估計協方差 (保持不變) ---
    initial_estimate_covariance: [1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                  0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                  0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                  0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                  0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                  0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                                  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0, 0.0,
                                  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0, 0.0,
                                  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0, 0.0,
                                  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0, 0.0,
                                  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9, 0.0,
                                  0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1e-9]

